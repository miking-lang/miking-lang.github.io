import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Install Miking

We currently support two methods of installing Miking:

 1. Natively built using the Opam package manager. (Mac, Linux)
 2. Pre-built Docker images with optional dependencies included. (Windows, Mac, Linux)

For basic usage of Miking with a limited set of dependencies, we recommend the
first option. If any of the extended Miking features are required, or if Opam
is not suitable for your system, then we recommend installing one of the Docker
images.

We also provide syntax highlighting for some of the popular editors. See the
[Install Syntax Highlighter](#install-syntax-highlighter) section for more
information.

## Native Install with Opam (Mac, Linux)

For native install, `opam` is required and `make` is highly
recommended.

:::info Install Opam

See the [Opam installation guide](https://opam.ocaml.org/doc/Install.html) for
how to install Opam on Mac or on your Linux distribution:
[Link](https://opam.ocaml.org/doc/Install.html)

:::

Create the Opam 4.12 switch:

```
opam update
opam switch create 4.12.0+domains --packages=ocaml-variants.4.12.0+domains --repositories=multicore=git+https://github.com/ocaml-multicore/multicore-opam.git,default
eval $(opam env)
```

Install required dependencies:

```
opam install dune linenoise
```

:::tip Optional Dependencies

Some features in the standard library will not work without these:

```
opam install pyml toml lwt owl ocamlformat.0.20.1
```
:::

Clone the Miking git repository to a suitable location on your system and enter
the directory:

```
git clone https://github.com/miking-lang/miking.git
cd miking
```

If you do not have `git` installed on your system then you can manually
download a zip file of the source code from our GitHub page:
[https://github.com/miking-lang/miking/archive/refs/heads/develop.zip](https://github.com/miking-lang/miking/archive/refs/heads/develop.zip)

Assuming that you have downloaded the repository and are currently located in
that directory, then you can either install Miking on your system with `make`
or directly from your shell:

:::info Install Miking

<Tabs>
<TabItem value="mi-install-makefile" label="Makefile" default>

With `make` available, we can install Miking as:

```
make install
```
</TabItem>

<TabItem value="mi-install-shell" label="Shell">

If `make` is not available on your system, then you can directly install Miking
by running the provided `./make` shell script as:

```
./make boot && ./make install-boot && ./make && ./make install
```
</TabItem>
</Tabs>

:::

## Install with Docker (Windows, Mac, Linux)

Before running the Docker image you must ensure that Docker is installed.

:::info Install Docker on Your Platform

<Tabs>
<TabItem value="docker-windows" label="Windows" default>
For Windows you will need to install the Docker Desktop application. See <a href="https://docs.docker.com/desktop/install/windows-install">this page</a> for more info. Any 

Docker desktop. WSL2 installation, powershell script.
</TabItem>

<TabItem value="docker-mac" label="Mac">
For Mac you will need to install the Docker Desktop application. See <a href="https://docs.docker.com/desktop/install/mac-install">this page</a> for more info. Make sure that you know if you are running an older Mac with Intel chip or a newer one with Apple Silicon. Download the appropriate Docker Desktop release.
<br /><br />
Due to the current performance of Docker on Mac, we highly recommend using Opam if possible.
<br /><br />
Now install the CLI interface for Docker using <a href="https://docs.brew.sh/Installation">Homebrew</a>:

    brew install docker

Now you should be able to run Docker containers from the terminal through the <code>docker</code> command, given that the Docker Desktop application is running.
</TabItem>

<TabItem value="docker-linux" label="Linux">
For Linux we recommend using Docker Engine. See <a href="https://docs.docker.com/engine/install">this page</a> for more information about how to install Docker Engine for your Linux distribution.
<br /><br />
If using Arch Linux or one of its derivatives, follow the instructions on the Arch Wiki page (<a href="https://wiki.archlinux.org/title/Docker">link</a>) instead.
<br /><br />
It is possible that your Docker Engine process is running with root privileges. <b>In this case you will need to run all commands below with <code>sudo</code> or add yourself to the docker group.</b> If unsure, try running a Docker command without <code>sudo</code> first.
</TabItem>
</Tabs>

:::

Fetch the image by downloading it from Docker Hub:

```
docker pull mikinglang/miking
```

If you are in need of CUDA functionality, you can pull the CUDA image instead:

```
docker pull mikinglang/miking:latest-cuda
```

Both contain all dependencies necessary to use all features in the standard
library. If you however desire to use the GPU acceleration feature in Miking,
you should use the CUDA-based image.

:::caution

An executable built inside the Docker image should only be executed inside the Docker image.

:::

Now you can run the Docker image as:

```
docker run --rm -it mikinglang/miking bash
```

This will launch the miking Docker image with a bash shell where you have
access to the `mi` command. The standard Docker image is based on Alpine and
if additional features are desired within the Docker container such as an
editor then they can be installed with the `apk` package manager.

All dependencies necessary for rebuilding the Miking compiler is also included
in the Docker image should you wish to do any modifications. You will also find
the Miking source code under `/src/miking` included in the image.

### Example Launch Scripts

The entire Docker run command can be a bit cumbersome to type every time you
want to compile something with Miking. We therefore recommend some suggestions
of scripts for starting the Miking container:

:::note Docker Helper scripts

<Tabs>
<TabItem value="dockerlaunch-makefile" label="Makefile" default>

Using GNU Make to launch the image with `make run-docker`:

```makefile
run-docker:
    $(eval IMAGE := mikinglang/miking:latest-alpine)
    $(eval CONTAINERNAME := hello-miking)
    $(eval PWD := $(shell pwd))
    docker run --name $(CONTAINERNAME)     \
               --hostname $(CONTAINERNAME) \
               --rm -it                    \
               -v "$(PWD):/mnt:ro"         \
               $(IMAGE) bash
```

This will mount the directory where the Makefile is located under `/mnt`. If
also with to write data to the same directory then this can be done by removing
the `:ro` part.

If you need to run Docker with `sudo`, then either prepend the `docker run`
in the Makefile rule with `sudo` or instead run `sudo make docker-run`.
</TabItem>
<TabItem value="dockerlaunch-bash" label="Bash" default>

Using a Bash script launch the image with `./midock.sh`:

```bash
#!/usr/bin/env bash

IMAGE='mikinglang/miking:latest-alpine'
CONTAINERNAME='hello-miking'

# This can be used to help you specify relative directory to the Bash
# script itself.
RELDIR="$(cd "$(dirname "$BASH_SOURCE")" >/dev/null 2>&1; pwd -P)"

exec docker run --name ${CONTAINERNAME}     \
                --hostname ${CONTAINERNAME} \
                --rm -it                    \
                -v "$(pwd):/mnt:ro"         \
                ${IMAGE} bash
```

Make it executable by running `chmod +x midock.sh`.

This will mount the current directory when running the script under `/mnt` as
read-only. If you also wish to write data to the same directory then this can
be done by removing the `:ro` part. If you wish to mount the directory where
the Bash script is located then replace the `-v $(pwd):/mnt:ro` with
`-v "${RELDIR}:/mnt:ro"`.

If you need to run Docker with `sudo`, then either prepend the `docker run`
in the script with `sudo` or instead run `sudo ./midock.sh`.
</TabItem>
<TabItem value="dockerlaunch-powershell" label="Power Shell" default>

TODO: How to use Windows power shell
</TabItem>
</Tabs>

:::

Example MExpr program:

```mc
include "string.mc"

mexpr

let s1: String = "foo" in
let s2: [Char] = ['f', 'o', 'o'] in
utest s1 with s2 in

-- Fibonacci function
let fib = lam n.
  recursive let work = lam i. lam curr. lam next.
    if eqi i n then
      curr
    else
      work /- inline comment -/ (addi i 1) next (addi curr next)
  in
  work 0 0 1
in

utest fib 0 with 0 in
utest fib 1 with 1 in
utest fib 2 with 1 in
utest fib 3 with 2 in
utest fib 4 with 3 in
utest fib 5 with 5 in
utest fib 6 with 8 in
utest fib 7 with 13 in
()
```

## Install Syntax Highlighter

Syntax highlighting is available for Miking in the editors Vim, Emacs, VSCode,
and Sublime Text. See the corresponding tab below for information about how to
install Miking syntax highlighting for your editor.

:::note Choose your editor

<Tabs>
<TabItem value="syntax-vim" label="Vim" default>

See the miking-vim GitHub repository:
[Link](https://github.com/miking-lang/miking-vim)
</TabItem>
<TabItem value="syntax-emacs" label="Emacs" default>

See the miking-emacs GitHub repository:
[Link](https://github.com/miking-lang/miking-emacs)
</TabItem>
<TabItem value="syntax-vscode" label="VSCode" default>

Download the vsix file from the GitHub releases page and install it using the
terminal:

```
curl -OL https://github.com/miking-lang/miking-vscode/releases/download/1.0.0/miking-core-vscode-1.0.0.vsix
code --install-extension miking-core-vscode-1.0.0.vsix
```

If you prefer to build it from source, see the GitHub page for more
information: [Link](https://github.com/miking-lang/miking-vscode)
</TabItem>
<TabItem value="syntax-sublime" label="Sublime Text" default>

Miking syntax highlighting is available on Package Control as
[Miking Syntax Highlighting](https://packagecontrol.io/packages/Miking%20Syntax%20Highlighting).

Assuming that you have Package Control installed, open the command palette by
Ctrl+Shift+P and select the _Package Control: Install Package_. Then choose
search for _Miking Syntax Highlighting_ and install the package. You might have
to reload any MCore files that you have open.
</TabItem>
</Tabs>

:::